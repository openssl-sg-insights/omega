
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.2.3, mkdocs-material-6.2.8" name="generator"/>
<title>API文档 - Omega帮助文档</title>
<link href="../assets/stylesheets/main.cb6bc1d0.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.39b8e14a.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
</head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#omega">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Omega帮助文档" class="md-header-nav__button md-logo" href=".." title="Omega帮助文档">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<div class="md-header-nav__topic">
<span class="md-ellipsis">
            Omega帮助文档
          </span>
</div>
<div class="md-header-nav__topic">
<span class="md-ellipsis">
            
              API文档
            
          </span>
</div>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Omega帮助文档" class="md-nav__button md-logo" href=".." title="Omega帮助文档">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
    Omega帮助文档
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        简介
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../deployment/">
        安装
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../usage/">
        使用手册
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://www.jieyu.ai">
        社区
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../history/">
        版本历史
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          API文档
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        API文档
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega">
    omega
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.app">
    app
  </a>
<nav aria-label="app" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.app.start">
    start()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli">
    cli
  </a>
<nav aria-label="cli" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.bin_cut">
    bin_cut()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.config_fetcher">
    config_fetcher()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.config_postgres">
    config_postgres()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.find_fetcher_processes">
    find_fetcher_processes()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.format_msg">
    format_msg()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.setup">
    setup()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.start">
    start()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.sync_bars">
    sync_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.sync_calendar">
    sync_calendar()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.sync_sec_list">
    sync_sec_list()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.config">
    config
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core">
    core
  </a>
<nav aria-label="core" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.accelerate">
    accelerate
  </a>
<nav aria-label="accelerate" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.accelerate.merge">
    merge()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity">
    sanity
  </a>
<nav aria-label="sanity" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.calc_checksums">
    calc_checksums()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.do_validation">
    do_validation()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.on_validation_error">
    on_validation_error()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.start_validation">
    start_validation()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher">
    fetcher
  </a>
<nav aria-label="fetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher">
    abstract_quotes_fetcher
  </a>
<nav aria-label="abstract_quotes_fetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher">
    AbstractQuotesFetcher
  </a>
<nav aria-label="AbstractQuotesFetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_all_trade_days">
    get_all_trade_days()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_bars">
    get_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_security_list">
    get_security_list()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_valuation">
    get_valuation()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive">
    archive
  </a>
<nav aria-label="archive" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive.adjust_range">
    adjust_range()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive.clear_range">
    clear_range()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive.main">
    main()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher">
    quotes_fetcher
  </a>
<nav aria-label="quotes_fetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher">
    QuotesFetcher
  </a>
<nav aria-label="QuotesFetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_all_trade_days">
    get_all_trade_days()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_bars">
    get_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_security_list">
    get_security_list()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_valuation">
    get_valuation()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs">
    jobs
  </a>
<nav aria-label="jobs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs">
    syncjobs
  </a>
<nav aria-label="syncjobs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.closing_quotation_sync_bars">
    closing_quotation_sync_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.load_sync_params">
    load_sync_params()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.parse_sync_params">
    parse_sync_params()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.reset_tail">
    reset_tail()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.sync_bars">
    sync_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.sync_calendar">
    sync_calendar()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.sync_security_list">
    sync_security_list()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.trigger_bars_sync">
    trigger_bars_sync()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.trigger_single_worker_sync">
    trigger_single_worker_sync()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega">
    omega
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.app">
    app
  </a>
<nav aria-label="app" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.app.start">
    start()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli">
    cli
  </a>
<nav aria-label="cli" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.bin_cut">
    bin_cut()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.config_fetcher">
    config_fetcher()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.config_postgres">
    config_postgres()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.find_fetcher_processes">
    find_fetcher_processes()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.format_msg">
    format_msg()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.setup">
    setup()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.start">
    start()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.sync_bars">
    sync_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.sync_calendar">
    sync_calendar()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.cli.sync_sec_list">
    sync_sec_list()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.config">
    config
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core">
    core
  </a>
<nav aria-label="core" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.accelerate">
    accelerate
  </a>
<nav aria-label="accelerate" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.accelerate.merge">
    merge()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity">
    sanity
  </a>
<nav aria-label="sanity" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.calc_checksums">
    calc_checksums()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.do_validation">
    do_validation()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.on_validation_error">
    on_validation_error()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.core.sanity.start_validation">
    start_validation()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher">
    fetcher
  </a>
<nav aria-label="fetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher">
    abstract_quotes_fetcher
  </a>
<nav aria-label="abstract_quotes_fetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher">
    AbstractQuotesFetcher
  </a>
<nav aria-label="AbstractQuotesFetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_all_trade_days">
    get_all_trade_days()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_bars">
    get_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_security_list">
    get_security_list()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_valuation">
    get_valuation()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive">
    archive
  </a>
<nav aria-label="archive" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive.adjust_range">
    adjust_range()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive.clear_range">
    clear_range()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.archive.main">
    main()
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher">
    quotes_fetcher
  </a>
<nav aria-label="quotes_fetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher">
    QuotesFetcher
  </a>
<nav aria-label="QuotesFetcher" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_all_trade_days">
    get_all_trade_days()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_bars">
    get_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_security_list">
    get_security_list()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_valuation">
    get_valuation()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs">
    jobs
  </a>
<nav aria-label="jobs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs">
    syncjobs
  </a>
<nav aria-label="syncjobs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.closing_quotation_sync_bars">
    closing_quotation_sync_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.load_sync_params">
    load_sync_params()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.parse_sync_params">
    parse_sync_params()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.reset_tail">
    reset_tail()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.sync_bars">
    sync_bars()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.sync_calendar">
    sync_calendar()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.sync_security_list">
    sync_security_list()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.trigger_bars_sync">
    trigger_bars_sync()
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#omega.jobs.syncjobs.trigger_single_worker_sync">
    trigger_single_worker_sync()
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<h1>API文档</h1>
<div class="doc doc-object doc-module">
<h3 class="hidden-toc" href="#omega" id="omega" style="visibility: hidden; position: absolute;">
<a class="headerlink" href="#omega" title="Permanent link">¶</a></h3>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="omega.app">
<code>app</code>
<a class="headerlink" href="#omega.app" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<p>Author: Aaron-Yang [code@jieyu.ai]
Contributors:</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.app.start">
<code class="highlight language-python">
start<span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fetcher_params</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.app.start" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>启动一个Omega fetcher进程</p>
<p>使用本函数来启动一个Omega fetcher进程。该进程可能与其它进程一样，使用相同的impl和账号，因此构成一组进程。</p>
<p>通过多次调用本方法，传入不同的quotes fetcher impl参数，即可启动多组Omega服务。</p>
<p>如果指定了<code>fetcher_params</code>，则<code>start</code>将使用impl, fetcher_params来启动单个Omega服务，使
用impl指定的fetcher。否则，将使用<code>cfg.quotes_fetcher</code>中提供的信息来创建Omega.</p>
<p>如果<code>cfg</code>不为None，则应该指定为合法的json string，其内容将覆盖本地cfg。这个设置目前的主要
要作用是方便单元测试。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>impl</code></td>
<td><code>str</code></td>
<td>
<p>quotes fetcher implementor</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>cfg</code></td>
<td><code>dict</code></td>
<td>
<p>the cfg in json string</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>fetcher_params</code></td>
<td><code></code></td>
<td>
<p>contains info required by creating quotes fetcher</p>
</td>
<td><code>{}</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/app.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">impl</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fetcher_params</span><span class="p">):</span>
    <span class="sd">"""启动一个Omega fetcher进程</span>

<span class="sd">    使用本函数来启动一个Omega fetcher进程。该进程可能与其它进程一样，使用相同的impl和账号，因此构成一组进程。</span>

<span class="sd">    通过多次调用本方法，传入不同的quotes fetcher impl参数，即可启动多组Omega服务。</span>

<span class="sd">    如果指定了`fetcher_params`，则`start`将使用impl, fetcher_params来启动单个Omega服务，使</span>
<span class="sd">    用impl指定的fetcher。否则，将使用`cfg.quotes_fetcher`中提供的信息来创建Omega.</span>

<span class="sd">    如果`cfg`不为None，则应该指定为合法的json string，其内容将覆盖本地cfg。这个设置目前的主要</span>
<span class="sd">    要作用是方便单元测试。</span>


<span class="sd">    Args:</span>
<span class="sd">        impl (str): quotes fetcher implementor</span>
<span class="sd">        cfg: the cfg in json string</span>
<span class="sd">        fetcher_params: contains info required by creating quotes fetcher</span>
<span class="sd">    """</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">fetcher_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"port"</span><span class="p">,</span> <span class="mi">3181</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">Omega</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="o">**</span><span class="n">fetcher_params</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">register_listener</span><span class="p">(</span><span class="n">omega</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s2">"before_server_start"</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"starting sanic group listen on </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2"> workers"</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">register_sys_signals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="n">WebSocketProtocol</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"sanic stopped."</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="omega.cli">
<code>cli</code>
<a class="headerlink" href="#omega.cli" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<p>管理应用程序生命期、全局对象、任务、全局消息响应</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.bin_cut">
<code class="highlight language-python">
bin_cut<span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.cli.bin_cut" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>将数组arr切分成n份</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>arr</code></td>
<td><code>list</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>n</code></td>
<td><code>int</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">bin_cut</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">"""将数组arr切分成n份</span>

<span class="sd">    Args:</span>
<span class="sd">        arr ([type]): [description]</span>
<span class="sd">        n ([type]): [description]</span>

<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    """</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.config_fetcher">
<code class="highlight language-python">
config_fetcher<span class="p">(</span><span class="n">settings</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.cli.config_fetcher" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>配置jq_fetcher</p>
<p>为Omega安装jqdatasdk, zillionare-omega-adaptors-jq, 配置jqdata访问账号</p>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">config_fetcher</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">"""配置jq_fetcher</span>

<span class="sd">    为Omega安装jqdatasdk, zillionare-omega-adaptors-jq, 配置jqdata访问账号</span>

<span class="sd">    """</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        Omega需要配置上游行情服务器。当前支持的上游服务器有:</span><span class="se">\\</span><span class="s2">n</span>
<span class="s2">        [1] 聚宽`&lt;joinquant&gt;`</span><span class="se">\\</span><span class="s2">n</span>
<span class="s2">    """</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="n">more_account</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">3181</span>
    <span class="k">while</span> <span class="n">more_account</span><span class="p">:</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s2">"请输入账号:"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"JQ_ACCOUNT"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">""</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s2">"请输入密码:"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"JQ_PASSWORD"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">""</span><span class="p">)</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s2">"请输入并发会话数"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"默认值[1]"</span><span class="p">)</span>
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"account"</span><span class="p">:</span> <span class="n">account</span><span class="p">,</span>
                <span class="s2">"password"</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                <span class="s2">"sessions"</span><span class="p">:</span> <span class="n">sessions</span><span class="p">,</span>
                <span class="s2">"port"</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">more_account</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"继续配置新的账号[y|N]?</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"Y"</span>

    <span class="n">settings</span><span class="p">[</span><span class="s2">"quotes_fetchers"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">append_fetcher</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="p">{</span><span class="s2">"impl"</span><span class="p">:</span> <span class="s2">"jqadaptor"</span><span class="p">,</span> <span class="s2">"workers"</span><span class="p">:</span> <span class="n">workers</span><span class="p">})</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.config_postgres">
<code class="highlight language-python">
config_postgres<span class="p">(</span><span class="n">settings</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.cli.config_postgres" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>配置数据连接并进行测试</p>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">config_postgres</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">"""配置数据连接并进行测试"""</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">        配置数据库并非必须。如果您仅限于在某些场景下使用Zillionare-omega，也可以不配置</span>
<span class="s2">        数据库更多信息，</span><span class="se">\\</span><span class="s2">n请参阅https://readthedocs.org/projects/zillionare-omega/</span>

<span class="s2">        </span><span class="se">\\</span><span class="s2">n跳过此项[S], 任意键继续:</span>
<span class="s2">    """</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"S"</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">action</span> <span class="o">=</span> <span class="s2">"R"</span>
    <span class="k">while</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">"R"</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span>
            <span class="s2">"请输入服务器地址，"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"POSTGRES_HOST"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">"localhost"</span>
        <span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span>
            <span class="s2">"请输入服务器端口，"</span><span class="p">,</span> <span class="n">is_valid_port</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"POSTGRES_PORT"</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">5432</span>
        <span class="p">)</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s2">"请输入账号,"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"POSTGRES_USER"</span><span class="p">))</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s2">"请输入密码,"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"POSTGRES_PASSWORD"</span><span class="p">))</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span>
            <span class="s2">"请输入数据库名,"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"POSTGRES_DB"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">"zillionare"</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"正在测试Postgres连接..."</span><span class="p">)</span>
        <span class="n">dsn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"postgres://</span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dbname</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">check_postgres</span><span class="p">(</span><span class="n">dsn</span><span class="p">):</span>
            <span class="n">update_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">"postgres.dsn"</span><span class="p">,</span> <span class="n">dsn</span><span class="p">)</span>
            <span class="n">update_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">"postgres.enabled"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">colored</span><span class="p">(</span><span class="s1">'PASS'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">)</span><span class="si">}</span><span class="s2">] 数据库连接成功，并成功初始化！"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">colored</span><span class="p">(</span><span class="s1">'FAIL'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">)</span><span class="si">}</span><span class="s2">] 忽略错误[C]，重新输入[R]，退出[Q]"</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">choose_action</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.find_fetcher_processes">
<code class="highlight language-python">
find_fetcher_processes<span class="p">()</span> </code>
<a class="headerlink" href="#omega.cli.find_fetcher_processes" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>查找所有的omega(fetcher)进程</p>
<p>Omega进程在ps -aux中显示应该包含 omega.app --impl=&amp;ltfetcher&amp;gt --port=&amp;ltport&amp;gt信息</p>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_fetcher_processes</span><span class="p">():</span>
    <span class="sd">"""查找所有的omega(fetcher)进程</span>

<span class="sd">    Omega进程在ps -aux中显示应该包含 omega.app --impl=&amp;ltfetcher&amp;gt --port=&amp;ltport&amp;gt信息</span>
<span class="sd">    """</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">():</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">cmdline</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">"omega.app start"</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s2">"--impl"</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s2">"--port"</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"--impl=([^\s]+)"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="s2">""</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"--port=(\d+)"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="s2">""</span>

            <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">impl</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">pids</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.format_msg">
<code class="highlight language-python">
format_msg<span class="p">(</span><span class="n">msg</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.cli.format_msg" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>格式化msg并显示在控制台上</p>
<p>本函数允许在写代码时按格式要求进行缩进和排版，但在输出时，这些格式都会被移除；对较长的文本，
按每80个字符为一行进行输出。</p>
<p>如果需要在msg中插入换行或者制表符，使用<code>\n</code>和<code>\t</code>。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>msg</code></td>
<td><code>str</code></td>
<td></td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">"""格式化msg并显示在控制台上</span>

<span class="sd">    本函数允许在写代码时按格式要求进行缩进和排版，但在输出时，这些格式都会被移除；对较长的文本，</span>
<span class="sd">    按每80个字符为一行进行输出。</span>

<span class="sd">    如果需要在msg中插入换行或者制表符，使用`\\n`和`\\t`。</span>
<span class="sd">    args:</span>
<span class="sd">        msg:</span>

<span class="sd">    returns:</span>
<span class="sd">    """</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\n\s+"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[\t\n]"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">t"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">n"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">/</span> <span class="mi">80</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">80</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)])</span>
    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.setup">
<code class="highlight language-python">
setup<span class="p">(</span><span class="n">reset_factory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.cli.setup" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>安装初始化入口</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>reset_factory</code></td>
<td><code></code></td>
<td>
<p>reset to factory settings</p>
</td>
<td><code>False</code></td>
</tr>
<tr>
<td><code>force</code></td>
<td><code></code></td>
<td>
<p>if true, force setup no matter if run already</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">reset_factory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""安装初始化入口</span>

<span class="sd">    Args:</span>
<span class="sd">        reset_factory: reset to factory settings</span>
<span class="sd">        force: if true, force setup no matter if run already</span>

<span class="sd">    Returns:</span>

<span class="sd">    """</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Zillionare-omega (大富翁)</span><span class="se">\\</span><span class="s2">n</span>
<span class="s2">    -------------------------</span><span class="se">\\</span><span class="s2">n</span>
<span class="s2">    感谢使用Zillionare-omega -- 高速分布式行情服务器！</span><span class="se">\\</span><span class="s2">n</span>
<span class="s2">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_config_dir</span><span class="p">(),</span> <span class="s2">"defaults.yaml"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">colored</span><span class="p">(</span><span class="s1">'[PASS]'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">)</span><span class="si">}</span><span class="s2"> 安装程序已在本机上成功运行"</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reset_factory</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sh</span>

        <span class="n">dst</span> <span class="o">=</span> <span class="n">get_config_dir</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">factory_config_dir</span><span class="p">(),</span> <span class="s2">"defaults.yaml"</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_config_dir</span><span class="p">(),</span> <span class="s2">"defaults.yaml"</span><span class="p">)</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">cp</span><span class="p">(</span><span class="s2">"-r"</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

    <span class="n">print_title</span><span class="p">(</span><span class="s2">"Step 1. 检测安装环境..."</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">load_factory_settings</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_environment</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">print_title</span><span class="p">(</span><span class="s2">"Step 2. 配置日志"</span><span class="p">)</span>
    <span class="n">config_logging</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">print_title</span><span class="p">(</span><span class="s2">"Step 3. 配置上游服务器"</span><span class="p">)</span>
    <span class="n">config_fetcher</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">print_title</span><span class="p">(</span><span class="s2">"Step 4. 配置Redis服务器"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">config_redis</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">print_title</span><span class="p">(</span><span class="s2">"Step 5. 配置Postgres服务器"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">config_postgres</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">save_config</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">print_title</span><span class="p">(</span><span class="s2">"Step 6. 下载历史数据"</span><span class="p">)</span>
    <span class="n">config_dir</span> <span class="o">=</span> <span class="n">get_config_dir</span><span class="p">()</span>
    <span class="n">cfg4py</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">remove_console_log_handler</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">start</span><span class="p">(</span><span class="s2">"fetcher"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">download_archive</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">print_title</span><span class="p">(</span><span class="s2">"配置已完成。现在为您启动Omega,开启财富之旅！"</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">start</span><span class="p">(</span><span class="s2">"jobs"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">status</span><span class="p">()</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.start">
<code class="highlight language-python">
start<span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.cli.start" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>启动omega主进程或者任务管理进程</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>service</code></td>
<td><code>str</code></td>
<td>
<p>if service is '', then starts fetcher processes.</p>
</td>
<td><code>''</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">):</span>
    <span class="sd">"""启动omega主进程或者任务管理进程</span>

<span class="sd">    Args:</span>
<span class="sd">        service: if service is '', then starts fetcher processes.</span>

<span class="sd">    Returns:</span>

<span class="sd">    """</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"正在启动zillionare-omega </span><span class="si">{</span><span class="n">colored</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">)</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="n">config_dir</span> <span class="o">=</span> <span class="n">get_config_dir</span><span class="p">()</span>
    <span class="n">cfg4py</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">service</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">_start_jobs</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">_start_fetcher_processes</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s2">"jobs"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_start_jobs</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">service</span> <span class="o">==</span> <span class="s2">"fetcher"</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_start_fetcher_processes</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"不支持的服务"</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.sync_bars">
<code class="highlight language-python">
sync_bars<span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.cli.sync_bars" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>立即同步行情数据</p>
<p>如果<code>frame</code>, <code>codes</code>没有提供，则从配置文件中读取相关信息</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>frame</code></td>
<td><code>str</code></td>
<td></td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>codes</code></td>
<td><code>str</code></td>
<td></td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">sync_bars</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">codes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""立即同步行情数据</span>

<span class="sd">    如果`frame`, `codes`没有提供，则从配置文件中读取相关信息</span>

<span class="sd">    Args:</span>
<span class="sd">        frame:</span>
<span class="sd">        codes:</span>

<span class="sd">    Returns:</span>

<span class="sd">    """</span>
    <span class="k">await</span> <span class="n">_init</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
        <span class="n">frame_type</span> <span class="o">=</span> <span class="n">FrameType</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">syncjobs</span><span class="o">.</span><span class="n">load_sync_params</span><span class="p">(</span><span class="n">frame_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">codes</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">"cat"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">"include"</span><span class="p">]</span> <span class="o">=</span> <span class="n">codes</span>
        <span class="k">await</span> <span class="n">syncjobs</span><span class="o">.</span><span class="n">trigger_bars_sync</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"request </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> send to workers."</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">frame_type</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_level_frames</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">minute_level_frames</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">syncjobs</span><span class="o">.</span><span class="n">load_sync_params</span><span class="p">(</span><span class="n">frame_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">codes</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">"cat"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">"include"</span><span class="p">]</span> <span class="o">=</span> <span class="n">codes</span>
            <span class="k">await</span> <span class="n">syncjobs</span><span class="o">.</span><span class="n">trigger_bars_sync</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"request </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> send to workers."</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.sync_calendar">
<code class="highlight language-python">
sync_calendar<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.cli.sync_calendar" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>发起同步交易日历请求</p>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">sync_calendar</span><span class="p">():</span>
    <span class="sd">"""发起同步交易日历请求"""</span>
    <span class="k">await</span> <span class="n">_init</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">syncjobs</span><span class="o">.</span><span class="n">trigger_single_worker_sync</span><span class="p">(</span><span class="s2">"calendar"</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h4 class="doc doc-heading" id="omega.cli.sync_sec_list">
<code class="highlight language-python">
sync_sec_list<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.cli.sync_sec_list" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>发起同步证券列表请求</p>
<details class="quote">
<summary>Source code in <code>omega/cli.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">sync_sec_list</span><span class="p">():</span>
    <span class="sd">"""发起同步证券列表请求"""</span>
    <span class="k">await</span> <span class="n">_init</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">syncjobs</span><span class="o">.</span><span class="n">trigger_single_worker_sync</span><span class="p">(</span><span class="s2">"security_list"</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="omega.config">
<code>config</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#omega.config" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<p>Author: Aaron-Yang [code@jieyu.ai]
Contributors:</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="omega.core">
<code>core</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#omega.core" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<p>Author: Aaron-Yang [code@jieyu.ai]
Contributors:</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="omega.core.accelerate">
<code>accelerate</code>
<a class="headerlink" href="#omega.core.accelerate" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>Author: Aaron-Yang [code@jieyu.ai]
Contributors:</p>
<p>things need speed</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.core.accelerate.merge">
<code class="highlight language-python">
merge<span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.core.accelerate.merge" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>merge two numpy structured arrays by <code>by</code> key</p>
<p>njit fail if one of left, right contains object, not plain type, but the loop is
very fast, cost 0.0001 seconds</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>left</code></td>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>right</code></td>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>by</code></td>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/core/accelerate.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
    <span class="sd">"""merge two numpy structured arrays by `by` key</span>

<span class="sd">    njit fail if one of left, right contains object, not plain type, but the loop is</span>
<span class="sd">    very fast, cost 0.0001 seconds</span>

<span class="sd">    Args:</span>
<span class="sd">        left ([type]): [description]</span>
<span class="sd">        right ([type]): [description]</span>
<span class="sd">        by ([type]): [description]</span>

<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    """</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">right</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">by</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">left</span><span class="p">[</span><span class="n">by</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">right</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">by</span><span class="p">]</span> <span class="o">==</span> <span class="n">left</span><span class="p">[</span><span class="n">by</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">left</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">left</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="omega.core.sanity">
<code>sanity</code>
<a class="headerlink" href="#omega.core.sanity" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>Author: Aaron-Yang [code@jieyu.ai]
Contributors:</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.core.sanity.calc_checksums">
<code class="highlight language-python">
calc_checksums<span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.core.sanity.calc_checksums" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>day</code></td>
<td><code>date</code></td>
<td></td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>codes</code></td>
<td><code>List</code></td>
<td></td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dict</code></td>
<td>
<p>返回值为以code为键，该证券对应的{周期：checksum}的集合为值的集合</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/core/sanity.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">calc_checksums</span><span class="p">(</span><span class="n">day</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">codes</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">        day:</span>
<span class="sd">        codes:</span>

<span class="sd">    Returns:</span>
<span class="sd">        返回值为以code为键，该证券对应的{周期：checksum}的集合为值的集合</span>
<span class="sd">    """</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">checksums</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codes</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">checksum</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">d</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_bars_raw_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">checksum</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xxhash</span><span class="o">.</span><span class="n">xxh32_hexdigest</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_bars_raw_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">checksum</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FrameType</span><span class="o">.</span><span class="n">MIN1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xxhash</span><span class="o">.</span><span class="n">xxh32_hexdigest</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_bars_raw_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">checksum</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FrameType</span><span class="o">.</span><span class="n">MIN5</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xxhash</span><span class="o">.</span><span class="n">xxh32_hexdigest</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_bars_raw_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">checksum</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FrameType</span><span class="o">.</span><span class="n">MIN15</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xxhash</span><span class="o">.</span><span class="n">xxh32_hexdigest</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_bars_raw_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">checksum</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FrameType</span><span class="o">.</span><span class="n">MIN30</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xxhash</span><span class="o">.</span><span class="n">xxh32_hexdigest</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_bars_raw_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN60</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">checksum</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FrameType</span><span class="o">.</span><span class="n">MIN60</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xxhash</span><span class="o">.</span><span class="n">xxh32_hexdigest</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">checksums</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">checksum</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"calc checksum progress: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">checksums</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.core.sanity.do_validation">
<code class="highlight language-python">
do_validation<span class="p">(</span><span class="n">secs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.core.sanity.do_validation" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>对列表secs中指定的证券行情数据按start到end指定的时间范围进行校验</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>secs</code></td>
<td><code>List[str]</code></td>
<td>
<p>[description]. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>start</code></td>
<td><code>str</code></td>
<td>
<p>[description]. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>end</code></td>
<td><code>str</code></td>
<td>
<p>[description]. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/core/sanity.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">do_validation</span><span class="p">(</span><span class="n">secs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""对列表secs中指定的证券行情数据按start到end指定的时间范围进行校验</span>

<span class="sd">    Args:</span>
<span class="sd">        secs (List[str], optional): [description]. Defaults to None.</span>
<span class="sd">        start (str, optional): [description]. Defaults to None.</span>
<span class="sd">        end (str, optional): [description]. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    """</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"start validation..."</span><span class="p">)</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"validation_report"</span><span class="p">)</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg4py</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">get_config_dir</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">emit</span><span class="o">.</span><span class="n">Engine</span><span class="o">.</span><span class="n">REDIS</span><span class="p">,</span> <span class="n">dsn</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">dsn</span><span class="p">,</span> <span class="n">start_server</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">omicron</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="ow">or</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"jobs.bars_validation.range.start"</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span> <span class="ow">or</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"jobs.bars_validation.range.stop"</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">secs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">get_sec</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">lpop</span><span class="p">(</span><span class="s2">"jobs.bars_validation.scope"</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">get_sec</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">secs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">code</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">get_sec</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span><span class="p">[(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]:</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_checksum</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">expected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                    <span class="n">actual</span> <span class="o">=</span> <span class="k">await</span> <span class="n">calc_checksums</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int2date</span><span class="p">(</span><span class="n">day</span><span class="p">),</span> <span class="p">[</span><span class="n">code</span><span class="p">])</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="n">actual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

                    <span class="n">missing1</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">d1</span>  <span class="c1"># local has no checksum</span>
                    <span class="n">missing2</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">d2</span>  <span class="c1"># remote has no checksum</span>
                    <span class="n">mismatch</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">d2</span> <span class="k">if</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">missing1</span><span class="p">:</span>
                        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ValidationError</span><span class="o">.</span><span class="n">LOCAL_MISS</span><span class="p">,</span>
                            <span class="n">day</span><span class="p">,</span>
                            <span class="n">code</span><span class="p">,</span>
                            <span class="n">k</span><span class="p">,</span>
                            <span class="n">d1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                            <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">report</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_VALIDATION_ERROR</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">missing2</span><span class="p">:</span>
                        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ValidationError</span><span class="o">.</span><span class="n">REMOTE_MISS</span><span class="p">,</span>
                            <span class="n">day</span><span class="p">,</span>
                            <span class="n">code</span><span class="p">,</span>
                            <span class="n">k</span><span class="p">,</span>
                            <span class="n">d1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                            <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">report</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_VALIDATION_ERROR</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mismatch</span><span class="p">:</span>
                        <span class="n">info</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ValidationError</span><span class="o">.</span><span class="n">MISMATCH</span><span class="p">,</span>
                            <span class="n">day</span><span class="p">,</span>
                            <span class="n">code</span><span class="p">,</span>
                            <span class="n">k</span><span class="p">,</span>
                            <span class="n">d1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                            <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">report</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_VALIDATION_ERROR</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"checksum for </span><span class="si">%s</span><span class="s2"> not found."</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">ValidationError</span><span class="o">.</span><span class="n">NO_CHECKSUM</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">report</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_VALIDATION_ERROR</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_VALIDATION_ERROR</span><span class="p">,</span> <span class="p">(</span><span class="n">ValidationError</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"do_validation meet </span><span class="si">%s</span><span class="s2"> unknown errors"</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.core.sanity.on_validation_error">
<code class="highlight language-python">
on_validation_error<span class="p">(</span><span class="n">report</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.core.sanity.on_validation_error" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>report</code></td>
<td><code>tuple</code></td>
<td>
<p>object like ::(reason, day, code, frame, local, remote)</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/core/sanity.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">on_validation_error</span><span class="p">(</span><span class="n">report</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">        report: object like ::(reason, day, code, frame, local, remote)</span>

<span class="sd">    Returns:</span>

<span class="sd">    """</span>
    <span class="k">global</span> <span class="n">validation_errors</span><span class="p">,</span> <span class="n">no_validation_error_days</span>

    <span class="c1"># todo: raise no checksum issue</span>
    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ValidationError</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
        <span class="n">no_validation_error_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">no_validation_error_days</span> <span class="o">-=</span> <span class="p">{</span><span class="n">report</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.core.sanity.start_validation">
<code class="highlight language-python">
start_validation<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.core.sanity.start_validation" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>将待校验的证券按CPU个数均匀划分，创建与CPU个数相同的子进程来执行校验。校验的起始时间由数据
库中jobs.bars_validation.range.start和jobs.bars_validation.range.stop来决定，每次校验
结束后，将jobs.bars_validation.range.start更新为校验截止的最后交易日。如果各个子进程报告
的截止交易日不一样（比如发生了异常），则使用最小的交易日。</p>
<details class="quote">
<summary>Source code in <code>omega/core/sanity.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start_validation</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    将待校验的证券按CPU个数均匀划分，创建与CPU个数相同的子进程来执行校验。校验的起始时间由数据</span>
<span class="sd">    库中jobs.bars_validation.range.start和jobs.bars_validation.range.stop来决定，每次校验</span>
<span class="sd">    结束后，将jobs.bars_validation.range.start更新为校验截止的最后交易日。如果各个子进程报告</span>
<span class="sd">    的截止交易日不一样（比如发生了异常），则使用最小的交易日。</span>
<span class="sd">    """</span>
    <span class="k">global</span> <span class="n">validation_errors</span><span class="p">,</span> <span class="n">no_validation_error_days</span>
    <span class="n">validation_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">secs</span> <span class="o">=</span> <span class="n">Securities</span><span class="p">()</span>

    <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="c1"># to check if the range is right</span>
    <span class="n">pl</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"jobs.bars_validation.range.start"</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"jobs.bars_validation.range.end"</span><span class="p">)</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pl</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"start of validation is not specified, validation aborted."</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span>

    <span class="n">no_validation_error_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span><span class="p">[(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="c1"># fixme: do validation per frame_type</span>
    <span class="c1"># fixme: test fail. Rewrite this before 0.6 releases</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="n">secs</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">sync</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"jobs.bars_validation.scope"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="s2">"jobs.bars_validation.scope"</span><span class="p">,</span> <span class="o">*</span><span class="n">codes</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"start validation </span><span class="si">%s</span><span class="s2"> secs from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">."</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">),</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="n">emit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_VALIDATION_ERROR</span><span class="p">,</span> <span class="n">on_validation_error</span><span class="p">)</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">code</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"from omega.core.sanity import do_validation_process_entry; "</span>
        <span class="s2">"do_validation_process_entry()"</span>
    <span class="p">)</span>

    <span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">):</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">"-c"</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>

    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="k">while</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">]):</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c1"># set next start point</span>
    <span class="n">validation_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span><span class="p">[(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">validation_days</span> <span class="o">-</span> <span class="n">no_validation_error_days</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
        <span class="n">last_no_error_day</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">last_no_error_day</span> <span class="o">=</span> <span class="n">end</span>

    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">"jobs.bars_validation.range.start"</span><span class="p">,</span> <span class="n">last_no_error_day</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">"Validation cost </span><span class="si">%s</span><span class="s2"> seconds, validation will start at </span><span class="si">%s</span><span class="s2"> next time"</span><span class="p">,</span>
        <span class="n">elapsed</span><span class="p">,</span>
        <span class="n">last_no_error_day</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="omega.fetcher">
<code>fetcher</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#omega.fetcher" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<p>quotes fetcher</p>
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="omega.fetcher.abstract_quotes_fetcher">
<code>abstract_quotes_fetcher</code>
<a class="headerlink" href="#omega.fetcher.abstract_quotes_fetcher" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>This is a awesome
python script!</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h5 class="doc doc-heading" id="omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher">
<code>AbstractQuotesFetcher</code>
<a class="headerlink" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_all_trade_days">
<code class="highlight language-python">
get_all_trade_days<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
<small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_all_trade_days" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>返回交易日历。不同的服务器可能返回的时间跨度不一样，但相同跨度内的时间应该一样。对已
经过去的交易日，可以用上证指数来验证。</p>
<details class="quote">
<summary>Source code in <code>omega/fetcher/abstract_quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_all_trade_days</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">days</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">get_all_trade_days</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">save_calendar</span><span class="p">(</span><span class="s2">"day_frames"</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">,</span> <span class="n">days</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">days</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_bars">
<code class="highlight language-python">
get_bars<span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n_bars</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">include_unclosed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
<small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_bars" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>获取行情数据，并将已结束的周期数据存入缓存。</p>
<p>各种情况：
1. 假设现在时间是2021-2-24日，盘中。此时请求上证指数日线，且<code>include_unclosed</code>为
<code>True</code>：
<div class="highlight">
<pre><span></span><code><span class="n">get_bars</span><span class="p">(</span><span class="s2">"000001.XSHE"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">)</span>
</code></pre>
</div>
得到的数据可能如下：
<div class="highlight">
<pre><span></span><code>[(datetime.date(2021, 2, 24), 3638.9358, 3645.5288, 3617.44, 3620.3542, ...)]
</code></pre>
</div>
在收盘前不同时间调用，得到的数据除开盘价外，其它都实时在变动。</p>
<ol>
<li>
<p>假设现在时间是2021-2-23日，盘后，此时请求上证指数日线，将得到收盘后固定的价格。</p>
</li>
<li>
<p>上述请求中，<code>include_unclosed</code>参数使用默认值(<code>True</code>)。如果取为<code>False</code>，仍以示例1
指定的场景为例，则:
<div class="highlight">
<pre><span></span><code><span class="n">get_bars</span><span class="p">(</span><span class="s2">"000001.XSHG"</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre>
</div>
因为2021-2-24日未收盘，所以获取的最后一条数据是2021-2-23日的。</p>
</li>
<li>
<p>同样假设现在时间是2021-2-24日盘中，周三。此时获取周K线。在<code>include_unclosed</code>分别为
<code>True</code>和<code>False</code>的情况下：
<div class="highlight">
<pre><span></span><code>[(datetime.date(2021, 2, 24), 3707.19, 3717.27, 3591.3647, 3592.3977, ...)]
[(datetime.date(2021, 2, 19), 3721.09, 3731.69, 3634.01, 3696.17, ...)]
</code></pre>
</div>
注意这里当<code>include_unclosed</code>为True时，返回的周K线是以2021-2-24为Frame的。同样，在盘中
的不同时间取这个数据，除了<code>open</code>数值之外，其它都是实时变化的。</p>
</li>
<li>
<p>如果在已结束的周期中，包含停牌数据，则会对停牌期间的数据进行nan填充，以方便数据使用
者可以较容易地分辨出数据不连贯的原因：哪些是停牌造成的，哪些是非交易日造成的。这种处理
会略微降低数据获取速度，并增加存储空间。</p>
</li>
</ol>
<p>比如下面的请求:
<div class="highlight">
<pre><span></span><code><span class="n">get_bars</span><span class="p">(</span><span class="s2">"000029.XSHE"</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">)</span>
</code></pre>
</div>
将获取到2020-8-5到2020-8-18间共10条数据。但由于期间000029这支股票处于停牌期，所以返回
的10条数据中，数值部分全部填充为np.nan。</p>
<p>注意如果取周线和月线数据，如果当天停牌，但只要周线有数据，则仍能取到。周线（或者月线）的
<code>frame</code>将是停牌前一交易日。比如，
<div class="highlight">
<pre><span></span><code><span class="n">sec</span> <span class="o">=</span> <span class="s2">"600721.XSHG"</span>
<span class="n">frame_type</span> <span class="o">=</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">WEEK</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"2020-4-29 15:00"</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span>
<span class="n">bars</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aq</span><span class="o">.</span><span class="n">get_bars</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">WEEK</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span>
</code></pre>
</div>
2020年4月30日是该周的最后一个交易日。股票600721在4月29日停牌一天。上述请求将得到如下数
据：
<div class="highlight">
<pre><span></span><code>[(datetime.date(2020, 4, 17), 6.02, 6.69, 5.84, 6.58, ...)
 (datetime.date(2020, 4, 24), 6.51, 6.57, 5.68, 5.72, ...)
 (datetime.date(2020, 4, 28), 5.7, 5.71, 5.17, 5.36, ...)]
</code></pre>
</div>
停牌发生在日线级别上，但我们的请求发生在周线级别上，所以不会对4/29日进行填充，而是返回
截止到4月29日的数据。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sec</code></td>
<td><code>str</code></td>
<td>
<p>证券代码</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>end</code></td>
<td><code>Union[datetime.date, datetime.datetime]</code></td>
<td>
<p>数据截止日</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>n_bars</code></td>
<td><code>int</code></td>
<td>
<p>待获取的数据条数</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>frame_type</code></td>
<td><code>FrameType</code></td>
<td>
<p>数据所属的周期</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>include_unclosed</code></td>
<td><code></code></td>
<td>
<p>如果为真，则会包含当end所处的那个Frame的数据，即使当前它还未结束</p>
</td>
<td><code>True</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/abstract_quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_bars</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">sec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span>
    <span class="n">n_bars</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">frame_type</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span>
    <span class="n">include_unclosed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""获取行情数据，并将已结束的周期数据存入缓存。</span>

<span class="sd">    各种情况：</span>
<span class="sd">    1. 假设现在时间是2021-2-24日，盘中。此时请求上证指数日线，且`include_unclosed`为</span>
<span class="sd">    `True`：</span>
<span class="sd">    ```python</span>
<span class="sd">    get_bars("000001.XSHE", None, 1, FrameType.DAY)</span>
<span class="sd">    ```</span>
<span class="sd">    得到的数据可能如下：</span>
<span class="sd">    ```</span>
<span class="sd">    [(datetime.date(2021, 2, 24), 3638.9358, 3645.5288, 3617.44, 3620.3542, ...)]</span>
<span class="sd">    ```</span>
<span class="sd">    在收盘前不同时间调用，得到的数据除开盘价外，其它都实时在变动。</span>

<span class="sd">    2. 假设现在时间是2021-2-23日，盘后，此时请求上证指数日线，将得到收盘后固定的价格。</span>

<span class="sd">    3. 上述请求中，`include_unclosed`参数使用默认值(`True`)。如果取为`False`，仍以示例1</span>
<span class="sd">    指定的场景为例，则:</span>
<span class="sd">    ```python</span>
<span class="sd">    get_bars("000001.XSHG", None, 1, FrameType.DAY, False)</span>
<span class="sd">    ```</span>
<span class="sd">    因为2021-2-24日未收盘，所以获取的最后一条数据是2021-2-23日的。</span>

<span class="sd">    4. 同样假设现在时间是2021-2-24日盘中，周三。此时获取周K线。在`include_unclosed`分别为</span>
<span class="sd">    `True`和`False`的情况下：</span>
<span class="sd">    ```</span>
<span class="sd">    [(datetime.date(2021, 2, 24), 3707.19, 3717.27, 3591.3647, 3592.3977, ...)]</span>
<span class="sd">    [(datetime.date(2021, 2, 19), 3721.09, 3731.69, 3634.01, 3696.17, ...)]</span>
<span class="sd">    ```</span>
<span class="sd">    注意这里当`include_unclosed`为True时，返回的周K线是以2021-2-24为Frame的。同样，在盘中</span>
<span class="sd">    的不同时间取这个数据，除了`open`数值之外，其它都是实时变化的。</span>

<span class="sd">    5. 如果在已结束的周期中，包含停牌数据，则会对停牌期间的数据进行nan填充，以方便数据使用</span>
<span class="sd">    者可以较容易地分辨出数据不连贯的原因：哪些是停牌造成的，哪些是非交易日造成的。这种处理</span>
<span class="sd">    会略微降低数据获取速度，并增加存储空间。</span>

<span class="sd">    比如下面的请求:</span>
<span class="sd">    ```python</span>
<span class="sd">    get_bars("000029.XSHE", datetime.date(2020,8,18), 10, FrameType.DAY)</span>
<span class="sd">    ```</span>
<span class="sd">    将获取到2020-8-5到2020-8-18间共10条数据。但由于期间000029这支股票处于停牌期，所以返回</span>
<span class="sd">    的10条数据中，数值部分全部填充为np.nan。</span>

<span class="sd">    注意如果取周线和月线数据，如果当天停牌，但只要周线有数据，则仍能取到。周线（或者月线）的</span>
<span class="sd">    `frame`将是停牌前一交易日。比如，</span>
<span class="sd">    ```python</span>
<span class="sd">    sec = "600721.XSHG"</span>
<span class="sd">    frame_type = FrameType.WEEK</span>

<span class="sd">    end = arrow.get("2020-4-29 15:00").datetime</span>
<span class="sd">    bars = await aq.get_bars(sec, end, 3, FrameType.WEEK)</span>
<span class="sd">    print(bars)</span>
<span class="sd">    ```</span>
<span class="sd">    2020年4月30日是该周的最后一个交易日。股票600721在4月29日停牌一天。上述请求将得到如下数</span>
<span class="sd">    据：</span>
<span class="sd">    ```</span>
<span class="sd">    [(datetime.date(2020, 4, 17), 6.02, 6.69, 5.84, 6.58, ...)</span>
<span class="sd">     (datetime.date(2020, 4, 24), 6.51, 6.57, 5.68, 5.72, ...)</span>
<span class="sd">     (datetime.date(2020, 4, 28), 5.7, 5.71, 5.17, 5.36, ...)]</span>
<span class="sd">    ```</span>
<span class="sd">    停牌发生在日线级别上，但我们的请求发生在周线级别上，所以不会对4/29日进行填充，而是返回</span>
<span class="sd">    截止到4月29日的数据。</span>

<span class="sd">    args:</span>
<span class="sd">        sec: 证券代码</span>
<span class="sd">        end: 数据截止日</span>
<span class="sd">        n_bars: 待获取的数据条数</span>
<span class="sd">        frame_type: 数据所属的周期</span>
<span class="sd">        include_unclosed: 如果为真，则会包含当end所处的那个Frame的数据，即使当前它还未结束</span>
<span class="sd">    """</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="ow">or</span> <span class="n">now</span><span class="o">.</span><span class="n">datetime</span>

    <span class="c1"># 如果end超出当前时间，则认为是不合法的。如果用户想取到最新的数据，应该传入None</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">bars</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">get_bars</span><span class="p">(</span>
        <span class="n">sec</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n_bars</span><span class="p">,</span> <span class="n">frame_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">include_unclosed</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># 根据指定的end，计算结束时的frame</span>
    <span class="n">last_closed_frame</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>

    <span class="n">last_frame</span> <span class="o">=</span> <span class="n">bars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"frame"</span><span class="p">]</span>

    <span class="c1"># 计算有多少根k线是已结束的</span>
    <span class="n">n_closed</span> <span class="o">=</span> <span class="n">n_bars</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">frame_type</span> <span class="o">==</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">:</span>
        <span class="c1"># 盘后取日线，返回的一定是全部都已closed的数据</span>
        <span class="c1"># 盘中取日线，返回的last_frame会是当天的日期，但该日线并未结束</span>
        <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">or</span> <span class="n">last_frame</span> <span class="o">&lt;</span> <span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
            <span class="n">n_closed</span> <span class="o">=</span> <span class="n">n_bars</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果last_frame &lt;= end的上限，则返回的也一定是全部都closed的数据</span>
        <span class="k">if</span> <span class="n">last_frame</span> <span class="o">&lt;=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">):</span>
            <span class="n">n_closed</span> <span class="o">=</span> <span class="n">n_bars</span>

    <span class="n">remainder</span> <span class="o">=</span> <span class="p">[</span><span class="n">bars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="n">n_closed</span> <span class="o">&lt;</span> <span class="n">n_bars</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">closed_bars</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fill_na</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">n_closed</span><span class="p">,</span> <span class="n">last_closed_frame</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>

    <span class="c1"># 只保存已结束的bar</span>
    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">save_bars</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">closed_bars</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remainder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">closed_bars</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">closed_bars</span><span class="p">,</span> <span class="n">remainder</span><span class="p">])</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_security_list">
<code class="highlight language-python">
get_security_list<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
<small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_security_list" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>按如下格式返回证券列表。</p>
<p>code         display_name   name   start_date   end_date   type
000001.XSHE   平安银行       PAYH   1991-04-03   2200-01-01 stock</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Union[NoneType, numpy.ndarray]</code></td>
<td>
<p>Union[None, np.ndarray]: [description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/abstract_quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_security_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">"""按如下格式返回证券列表。</span>

<span class="sd">    code         display_name   name   start_date   end_date   type</span>
<span class="sd">    000001.XSHE   平安银行       PAYH   1991-04-03   2200-01-01 stock</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[None, np.ndarray]: [description]</span>
<span class="sd">    """</span>
    <span class="n">securities</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">get_security_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">securities</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">securities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"failed to update securities. </span><span class="si">%s</span><span class="s2"> is returned."</span><span class="p">,</span> <span class="n">securities</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">securities</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">"securities"</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">display_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">securities</span><span class="p">:</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">rpush</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">,"</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="k">await</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">securities</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_valuation">
<code class="highlight language-python">
get_valuation<span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
<small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.abstract_quotes_fetcher.AbstractQuotesFetcher.get_valuation" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>读取code指定的股票在date指定日期的市值数据。</p>
<p>返回数据包括：
    code: 股票代码
    day: 日期
    captialization: 总股本
    circulating_cap: 流通股本（万股）
    market_cap: 总市值（亿元）
    circulating_market_cap： 流通市值（亿元）
    turnover_ration: 换手率（%）
    pe_ratio: 市盈率（PE,TTM）每股市价为每股收益的倍数，反映投资人对每元净利润所愿支付的价
    格，用来估计股票的投资报酬和风险
    pe_ratio_lyr: 市盈率（PE），以上一年度每股盈利计算的静态市盈率. 股价/最近年度报告EPS
    pb_ratio: 市净率（PB）
    ps_ratio: 市销率(PS)
    pcf_ratio: 市现率（PCF）</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>code</code></td>
<td><code>Union[str, List[str]]</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>day</code></td>
<td><code>date</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ndarray</code></td>
<td>
<p>numpy.ndarray: [description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/abstract_quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_valuation</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">code</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">day</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

    <span class="n">valuation</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">get_valuation</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">Valuation</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">valuation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valuation</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">]</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">valuation</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rfn</span><span class="o">.</span><span class="n">require_fields</span><span class="p">(</span><span class="n">valuation</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="omega.fetcher.archive">
<code>archive</code>
<a class="headerlink" href="#omega.fetcher.archive" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.fetcher.archive.adjust_range">
<code class="highlight language-python">
adjust_range<span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.archive.adjust_range" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>adjust secs's range after archive bars imported</p>
<details class="quote">
<summary>Source code in <code>omega/fetcher/archive.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">adjust_range</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">):</span>
    <span class="sd">"""adjust secs's range after archive bars imported"""</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"0"</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">"archive.ranges.*"</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"start adjust range"</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">cur</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">pl</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">lrange</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                <span class="n">arc_head</span><span class="p">,</span> <span class="n">arc_tail</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">code_frame_key</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"archive.ranges."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
                <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">hmget</span><span class="p">(</span><span class="n">code_frame_key</span><span class="p">,</span> <span class="s2">"head"</span><span class="p">,</span> <span class="s2">"tail"</span><span class="p">)</span>

                <span class="n">head</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="k">if</span> <span class="n">head</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">tail</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="k">if</span> <span class="n">tail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="c1"># head, tail, arc_head, arc_tail should be all frame-aligned</span>
                <span class="k">if</span> <span class="n">head</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tail</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">arc_head</span><span class="p">,</span> <span class="n">arc_tail</span>
                <span class="k">elif</span> <span class="n">arc_tail</span> <span class="o">&lt;</span> <span class="n">head</span> <span class="ow">or</span> <span class="n">arc_head</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">:</span>
                    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">arc_head</span><span class="p">,</span> <span class="n">arc_tail</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">head</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">arc_head</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
                    <span class="n">tail</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arc_tail</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">code_frame_key</span><span class="p">,</span> <span class="s2">"head"</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">code_frame_key</span><span class="p">,</span> <span class="s2">"tail"</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"failed to set range for </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">code_frame_key</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">pl</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.fetcher.archive.clear_range">
<code class="highlight language-python">
clear_range<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.archive.clear_range" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>clear cached secs's range before/after import archive bars</p>
<details class="quote">
<summary>Source code in <code>omega/fetcher/archive.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">clear_range</span><span class="p">():</span>
    <span class="sd">"""clear cached secs's range before/after import archive bars"""</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">"archive.ranges.*"</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.fetcher.archive.main">
<code class="highlight language-python">
main<span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">cats</span><span class="p">,</span> <span class="n">archive_server</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.fetcher.archive.main" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>允许将本模块以独立进程运行，以支持多进程</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>months</code></td>
<td><code>str</code></td>
<td>
<p>逗号分隔的月列表。格式如202012</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>cats</code></td>
<td><code>str</code></td>
<td>
<p>逗号分隔的类别列表，如"stock,index"</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/archive.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">months</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cats</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">archive_server</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""允许将本模块以独立进程运行，以支持多进程</span>

<span class="sd">    Args:</span>
<span class="sd">        months (str): 逗号分隔的月列表。格式如202012</span>
<span class="sd">        cats (str): 逗号分隔的类别列表，如"stock,index"</span>
<span class="sd">    """</span>
    <span class="n">config_dir</span> <span class="o">=</span> <span class="n">get_config_dir</span><span class="p">()</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg4py</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">archive_server</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">archive</span> <span class="o">=</span> <span class="n">archive_server</span>

    <span class="n">months</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">months</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cats</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)]</span>

    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_main</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">cats</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="omega.fetcher.quotes_fetcher">
<code>quotes_fetcher</code>
<a class="headerlink" href="#omega.fetcher.quotes_fetcher" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<p>Interface for quotes fetcher</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h5 class="doc doc-heading" id="omega.fetcher.quotes_fetcher.QuotesFetcher">
<code>QuotesFetcher</code>
<a class="headerlink" href="#omega.fetcher.quotes_fetcher.QuotesFetcher" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.quotes_fetcher.QuotesFetcher.get_all_trade_days">
<code class="highlight language-python">
get_all_trade_days<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_all_trade_days" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>返回交易日历。不同的服务器可能返回的时间跨度不一样，但相同跨度内的时间应该一样。对已
经过去的交易日，可以用上证指数来验证。</p>
<details class="quote">
<summary>Source code in <code>omega/fetcher/quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_all_trade_days</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    返回交易日历。不同的服务器可能返回的时间跨度不一样，但相同跨度内的时间应该一样。对已</span>
<span class="sd">    经过去的交易日，可以用上证指数来验证。</span>
<span class="sd">    """</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.quotes_fetcher.QuotesFetcher.get_bars">
<code class="highlight language-python">
get_bars<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">n_bars</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">allow_unclosed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_bars" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>取n个单位的k线数据。</p>
<p>k线周期由frame_type指定。最后结束周期为end。股票停牌期间的数据会使用None填充。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sec</code></td>
<td><code>str</code></td>
<td>
<p>证券代码</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>end</code></td>
<td><code>Union[datetime.date, datetime.datetime]</code></td>
<td></td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>n_bars</code></td>
<td><code>int</code></td>
<td></td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>frame_type</code></td>
<td><code>FrameType</code></td>
<td></td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>allow_unclosed</code></td>
<td><code>bool</code></td>
<td>
<p>为真时，当前未结束的帧数据也获取</p>
</td>
<td><code>True</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ndarray</code></td>
<td>
<p>a numpy.ndarray, with each element is:
'frame': datetime.date or datetime.datetime, depends on frame_type.
Denotes which time frame the data
belongs .
'open, high, low, close': float
'volume': double
'amount': the buy/sell amount in total, double
'factor': float, may exist or not</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_bars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span>
    <span class="n">n_bars</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">frame_type</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span>
    <span class="n">allow_unclosed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""取n个单位的k线数据。</span>

<span class="sd">    k线周期由frame_type指定。最后结束周期为end。股票停牌期间的数据会使用None填充。</span>
<span class="sd">    Args:</span>
<span class="sd">        sec (str): 证券代码</span>
<span class="sd">        end (Frame):</span>
<span class="sd">        n_bars (int):</span>
<span class="sd">        frame_type (FrameType):</span>
<span class="sd">        allow_unclosed (bool): 为真时，当前未结束的帧数据也获取</span>

<span class="sd">    Returns:</span>
<span class="sd">        a numpy.ndarray, with each element is:</span>
<span class="sd">        'frame': datetime.date or datetime.datetime, depends on frame_type.</span>
<span class="sd">        Denotes which time frame the data</span>
<span class="sd">        belongs .</span>
<span class="sd">        'open, high, low, close': float</span>
<span class="sd">        'volume': double</span>
<span class="sd">        'amount': the buy/sell amount in total, double</span>
<span class="sd">        'factor': float, may exist or not</span>
<span class="sd">    """</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.quotes_fetcher.QuotesFetcher.get_security_list">
<code class="highlight language-python">
get_security_list<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_security_list" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>fetch security list from server. The returned list is a numpy.ndarray,
which each elements
should look like:
code         display_name name  start_date  end_date     type
000001.XSHE  平安银行      PAYH  1991-04-03  2200-01-01   stock
000002.XSHE   万科A        WKA   1991-01-29  2200-01-01   stock</p>
<p>all fields are string type</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ndarray</code></td>
<td></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_security_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    fetch security list from server. The returned list is a numpy.ndarray,</span>
<span class="sd">    which each elements</span>
<span class="sd">    should look like:</span>
<span class="sd">    code         display_name name  start_date  end_date     type</span>
<span class="sd">    000001.XSHE  平安银行      PAYH  1991-04-03  2200-01-01   stock</span>
<span class="sd">    000002.XSHE   万科A        WKA   1991-01-29  2200-01-01   stock</span>

<span class="sd">    all fields are string type</span>
<span class="sd">    Returns:</span>

<span class="sd">    """</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-method">
<h6 class="doc doc-heading" id="omega.fetcher.quotes_fetcher.QuotesFetcher.get_valuation">
<code class="highlight language-python">
get_valuation<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.fetcher.quotes_fetcher.QuotesFetcher.get_valuation" title="Permanent link">¶</a></h6>
<div class="doc doc-contents">
<p>读取code指定的股票在date指定日期的市值数据。</p>
<p>返回数据包括：
    code: 股票代码
    day: 日期
    captialization: 总股本
    circulating_cap: 流通股本（万股）
    market_cap: 总市值（亿元）
    circulating_market_cap： 流通市值（亿元）
    turnover_ration: 换手率（%）
    pe_ratio: 市盈率（PE,TTM）每股市价为每股收益的倍数，反映投资人对每元净利润所愿支付的价
    格，用来估计股票的投资报酬和风险
    pe_ratio_lyr: 市盈率（PE），以上一年度每股盈利计算的静态市盈率. 股价/最近年度报告EPS
    pb_ratio: 市净率（PB）
    ps_ratio: 市销率(PS)
    pcf_ratio: 市现率（PCF）</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>code</code></td>
<td><code>Union[str, List[str]]</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>day</code></td>
<td><code>Union[datetime.date, datetime.datetime]</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ndarray</code></td>
<td>
<p>numpy.ndarray: [description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/fetcher/quotes_fetcher.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_valuation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">day</span><span class="p">:</span> <span class="n">Frame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""读取code指定的股票在date指定日期的市值数据。</span>

<span class="sd">    返回数据包括：</span>
<span class="sd">        code: 股票代码</span>
<span class="sd">        day: 日期</span>
<span class="sd">        captialization: 总股本</span>
<span class="sd">        circulating_cap: 流通股本（万股）</span>
<span class="sd">        market_cap: 总市值（亿元）</span>
<span class="sd">        circulating_market_cap： 流通市值（亿元）</span>
<span class="sd">        turnover_ration: 换手率（%）</span>
<span class="sd">        pe_ratio: 市盈率（PE,TTM）每股市价为每股收益的倍数，反映投资人对每元净利润所愿支付的价</span>
<span class="sd">        格，用来估计股票的投资报酬和风险</span>
<span class="sd">        pe_ratio_lyr: 市盈率（PE），以上一年度每股盈利计算的静态市盈率. 股价/最近年度报告EPS</span>
<span class="sd">        pb_ratio: 市净率（PB）</span>
<span class="sd">        ps_ratio: 市销率(PS)</span>
<span class="sd">        pcf_ratio: 市现率（PCF）</span>

<span class="sd">    Args:</span>
<span class="sd">        code (Union[str, List[str]]): [description]</span>
<span class="sd">        day (Frame): [description]</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: [description]</span>
<span class="sd">    """</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<h3 class="doc doc-heading" id="omega.jobs">
<code>jobs</code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
<a class="headerlink" href="#omega.jobs" title="Permanent link">¶</a></h3>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-module">
<h4 class="doc doc-heading" id="omega.jobs.syncjobs">
<code>syncjobs</code>
<a class="headerlink" href="#omega.jobs.syncjobs" title="Permanent link">¶</a></h4>
<div class="doc doc-contents">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.closing_quotation_sync_bars">
<code class="highlight language-python">
closing_quotation_sync_bars<span class="p">(</span><span class="n">all_params</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.closing_quotation_sync_bars" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>收盘之后从新同步今天的分钟线数据和日周月</p>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{
            "frame"</code></td>
<td>
<p>"1m",
            "start": "2020-01-02",
            "stop": "2020-01-02",
            "delay": 3,
            "cat": [],
            "include": "000001.XSHE",
            "exclude": "000001.XSHG",
        },</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">closing_quotation_sync_bars</span><span class="p">(</span><span class="n">all_params</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    收盘之后从新同步今天的分钟线数据和日周月</span>
<span class="sd">    Returns:</span>
<span class="sd">        {</span>
<span class="sd">                    "frame": "1m",</span>
<span class="sd">                    "start": "2020-01-02",</span>
<span class="sd">                    "stop": "2020-01-02",</span>
<span class="sd">                    "delay": 3,</span>
<span class="sd">                    "cat": [],</span>
<span class="sd">                    "include": "000001.XSHE",</span>
<span class="sd">                    "exclude": "000001.XSHG",</span>
<span class="sd">                },</span>
<span class="sd">    """</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"正在同步今天的分钟线数据和日周月"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">all_params</span><span class="p">:</span>
        <span class="n">codes</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">parse_sync_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reset_tail</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"start"</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">trigger_bars_sync</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.load_sync_params">
<code class="highlight language-python">
load_sync_params<span class="p">(</span><span class="n">frame_type</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.jobs.syncjobs.load_sync_params" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>根据指定的frame_type，从配置文件中加载同步参数</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>frame_type</code></td>
<td><code>FrameType</code></td>
<td>
<p>[description]</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dict</code></td>
<td>
<p>dict: see @[omega.jobs.syncjobs.parse_sync_params]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">load_sync_params</span><span class="p">(</span><span class="n">frame_type</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""根据指定的frame_type，从配置文件中加载同步参数</span>

<span class="sd">    Args:</span>
<span class="sd">        frame_type (FrameType): [description]</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: see @[omega.jobs.syncjobs.parse_sync_params]</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">sync</span><span class="o">.</span><span class="n">bars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"frame"</span><span class="p">)</span> <span class="o">==</span> <span class="n">frame_type</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">secs</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">parse_sync_params</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"failed to parse </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.parse_sync_params">
<code class="highlight language-python">
parse_sync_params<span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> </code>
<a class="headerlink" href="#omega.jobs.syncjobs.parse_sync_params" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>按照<a href="../usage/#22-如何同步K线数据">使用手册</a>中的规则，解析和补全同步参数。</p>
<p>如果<code>frame_type</code>为分钟级，则当<code>start</code>指定为<code>date</code>类型时，自动更正为对应交易日的起始帧；
当<code>stop</code>为<code>date</code>类型时，自动更正为对应交易日的最后一帧。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>frame</code></td>
<td><code>Union[str, datetime.date, datetime.datetime]</code></td>
<td>
<p>frame type to be sync.  The word <code>frame</code> is used
here for easy understand by end user. It actually implies "FrameType".</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>cat</code></td>
<td><code>List[str]</code></td>
<td>
<p>which catetories is about to be synced. Should be one of
['stock', 'index']. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>start</code></td>
<td><code>Union[str, datetime.date]</code></td>
<td>
<p>[description]. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>stop</code></td>
<td><code>Union[str, datetime.date, datetime.datetime]</code></td>
<td>
<p>[description]. Defaults to None.</p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>delay</code></td>
<td><code>int</code></td>
<td>
<p>[description]. Defaults to 5.</p>
</td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>include</code></td>
<td><code>str</code></td>
<td>
<p>which securities should be included, seperated by
space, for example, "000001.XSHE 000004.XSHE". Defaults to empty string.</p>
</td>
<td><code>''</code></td>
</tr>
<tr>
<td><code>exclude</code></td>
<td><code>str</code></td>
<td>
<p>which securities should be excluded, seperated by
a space. Defaults to empty string.</p>
</td>
<td><code>''</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Tuple</code></td>
<td>
<ul>
<li>codes (List[str]): 待同步证券列表</li>
<li>frame_type (FrameType):</li>
<li>start (Frame):</li>
<li>stop (Frame):</li>
<li>delay (int):</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_sync_params</span><span class="p">(</span>
    <span class="n">frame</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Frame</span><span class="p">],</span>
    <span class="n">cat</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Frame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="sd">"""按照[使用手册](usage.md#22-如何同步K线数据)中的规则，解析和补全同步参数。</span>

<span class="sd">    如果`frame_type`为分钟级，则当`start`指定为`date`类型时，自动更正为对应交易日的起始帧；</span>
<span class="sd">    当`stop`为`date`类型时，自动更正为对应交易日的最后一帧。</span>
<span class="sd">    Args:</span>
<span class="sd">        frame (Union[str, Frame]): frame type to be sync.  The word ``frame`` is used</span>
<span class="sd">            here for easy understand by end user. It actually implies "FrameType".</span>
<span class="sd">        cat (List[str]): which catetories is about to be synced. Should be one of</span>
<span class="sd">            ['stock', 'index']. Defaults to None.</span>
<span class="sd">        start (Union[str, datetime.date], optional): [description]. Defaults to None.</span>
<span class="sd">        stop (Union[str, Frame], optional): [description]. Defaults to None.</span>
<span class="sd">        delay (int, optional): [description]. Defaults to 5.</span>
<span class="sd">        include (str, optional): which securities should be included, seperated by</span>
<span class="sd">            space, for example, "000001.XSHE 000004.XSHE". Defaults to empty string.</span>
<span class="sd">        exclude (str, optional):  which securities should be excluded, seperated by</span>
<span class="sd">            a space. Defaults to empty string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - codes (List[str]): 待同步证券列表</span>
<span class="sd">        - frame_type (FrameType):</span>
<span class="sd">        - start (Frame):</span>
<span class="sd">        - stop (Frame):</span>
<span class="sd">        - delay (int):</span>
<span class="sd">    """</span>
    <span class="n">frame_type</span> <span class="o">=</span> <span class="n">FrameType</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_type</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">minute_level_frames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 未指定有效的时间帧，使用当日结束帧</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">last_min_frame</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_shift</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">frame_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"请勿将同步截止时间设置在未来: </span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 未指定有效的交易帧，使用当日的起始帧</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">first_min_frame</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">day_shift</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">frame_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="ow">and</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="ow">or</span> <span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>

        <span class="n">stop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">start</span> <span class="ow">and</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()),</span> <span class="n">frame_type</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tf</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
            <span class="n">stop</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="n">frame_type</span>
        <span class="p">)</span>

    <span class="n">secs</span> <span class="o">=</span> <span class="n">Securities</span><span class="p">()</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="n">secs</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">cat</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="n">exclude</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">exclude</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">))</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span>

    <span class="n">include</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">include</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)))</span>
    <span class="n">codes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">include</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">codes</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.reset_tail">
<code class="highlight language-python">
reset_tail<span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">days</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.reset_tail" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>重置tail的值，来同步数据</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>days</code></td>
<td><code></code></td>
<td>
<p>需要重置到多少天之前</p>
</td>
<td><code>-1</code></td>
</tr>
<tr>
<td><code>codes</code></td>
<td><code>[]</code></td>
<td></td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>frame_type</code></td>
<td><code>FrameType</code></td>
<td></td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">reset_tail</span><span class="p">(</span><span class="n">codes</span><span class="p">:</span> <span class="p">[],</span> <span class="n">frame_type</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">days</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    重置tail的值，来同步数据</span>
<span class="sd">    Args:</span>
<span class="sd">        days: 需要重置到多少天之前</span>
<span class="sd">        codes:</span>
<span class="sd">        frame_type:</span>
<span class="sd">    Returns:</span>
<span class="sd">    """</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">_day</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">day_shift</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_type</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN1</span><span class="p">,</span>
        <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN5</span><span class="p">,</span>
        <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN15</span><span class="p">,</span>
        <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN30</span><span class="p">,</span>
        <span class="n">FrameType</span><span class="o">.</span><span class="n">MIN60</span><span class="p">]:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">_day</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">_day</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">_day</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">time2int</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">frame_type</span> <span class="o">==</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">DAY</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">_day</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">frame_type</span> <span class="o">==</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">WEEK</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">WEEK</span><span class="p">)</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">frame_type</span> <span class="o">==</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MONTH</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">FrameType</span><span class="o">.</span><span class="n">MONTH</span><span class="p">)</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"不支持的frame_type"</span><span class="p">)</span>
    <span class="c1"># print(f"reset tail to[m:{m}, day:{day}, week:{week}, month:{month}] ")</span>

    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">frame_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">"tail"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">_tail</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">_tail</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_tail</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">:</span>  <span class="c1"># 只有数据库里的时间大于tail 才可以</span>
            <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">'tail'</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1">'</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.sync_bars">
<code class="highlight language-python">
sync_bars<span class="p">(</span><span class="n">params</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.sync_bars" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>sync bars on signal OMEGA_DO_SYNC received</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>params</code></td>
<td><code>dict</code></td>
<td>
<p>composed of the following:
<div class="highlight">
<pre><span></span><code>{
    secs (List[str]): 待同步的证券标的.如果为None或者为空，则从数据库中轮询
    frame_type (FrameType):k线的帧类型
    start (Frame): k线起始时间
    stop (Frame): k线结束时间
}
</code></pre>
</div>
</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[type]</code></td>
<td>
<p>[description]</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">sync_bars</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">"""sync bars on signal OMEGA_DO_SYNC received</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict): composed of the following:</span>
<span class="sd">            ```</span>
<span class="sd">            {</span>
<span class="sd">                secs (List[str]): 待同步的证券标的.如果为None或者为空，则从数据库中轮询</span>
<span class="sd">                frame_type (FrameType):k线的帧类型</span>
<span class="sd">                start (Frame): k线起始时间</span>
<span class="sd">                stop (Frame): k线结束时间</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>
<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    """</span>
    <span class="n">secs</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"secs"</span><span class="p">),</span>
        <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"frame_type"</span><span class="p">),</span>
        <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span>
        <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"stop"</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"sync bars with </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> ~ </span><span class="si">%s</span><span class="s2">) for given </span><span class="si">%s</span><span class="s2"> secs"</span><span class="p">,</span>
            <span class="n">frame_type</span><span class="p">,</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="n">stop</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">get_sec</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">secs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"sync bars with </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> ~ </span><span class="si">%s</span><span class="s2">) in polling mode"</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span>
        <span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">get_sec</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">lpop</span><span class="p">(</span><span class="n">key_scope</span><span class="p">)</span>

    <span class="n">key_scope</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"jobs.bars_sync.scope.</span><span class="si">{</span><span class="n">frame_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">frame_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"you must specify a start date/frame_type for sync"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">tz</span><span class="p">),</span> <span class="n">frame_type</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">code</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">get_sec</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">sync_bars_for_security</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FetcherQuotaError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Quota exceeded when syncing </span><span class="si">%s</span><span class="s2">. Sync aborted."</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># stop the sync</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Failed to sync </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">elapsed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_stop_job_timer</span><span class="p">(</span><span class="s2">"sync"</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> finished quotes sync in </span><span class="si">%s</span><span class="s2"> seconds"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">elapsed</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.sync_calendar">
<code class="highlight language-python">
sync_calendar<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.sync_calendar" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>从上游服务器获取所有交易日，并计算出周线帧和月线帧</p>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">sync_calendar</span><span class="p">():</span>
    <span class="sd">"""从上游服务器获取所有交易日，并计算出周线帧和月线帧</span>

<span class="sd">    Returns:</span>
<span class="sd">    """</span>
    <span class="n">trade_days</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aq</span><span class="o">.</span><span class="n">get_all_trade_days</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">trade_days</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">trade_days</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"failed to fetch trade days."</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">tf</span><span class="o">.</span><span class="n">day_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">trade_days</span><span class="p">]</span>
    <span class="n">weeks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">trade_days</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">trade_days</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">last</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cur</span> <span class="o">-</span> <span class="n">last</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">weeks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">cur</span>

    <span class="k">if</span> <span class="n">weeks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">:</span>
        <span class="n">weeks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>

    <span class="n">tf</span><span class="o">.</span><span class="n">week_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">weeks</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">save_calendar</span><span class="p">(</span><span class="s2">"week_frames"</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">,</span> <span class="n">weeks</span><span class="p">))</span>

    <span class="n">months</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">trade_days</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">trade_days</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;</span> <span class="n">last</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
            <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">cur</span>
    <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>

    <span class="n">tf</span><span class="o">.</span><span class="n">month_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">months</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">save_calendar</span><span class="p">(</span><span class="s2">"month_frames"</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">date2int</span><span class="p">,</span> <span class="n">months</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"trade_days is updated to </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">trade_days</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.sync_security_list">
<code class="highlight language-python">
sync_security_list<span class="p">()</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.sync_security_list" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>更新证券列表</p>
<p>注意证券列表在AbstractQuotesServer取得时就已保存，此处只是触发</p>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">sync_security_list</span><span class="p">():</span>
    <span class="sd">"""更新证券列表</span>

<span class="sd">    注意证券列表在AbstractQuotesServer取得时就已保存，此处只是触发</span>
<span class="sd">    """</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aq</span><span class="o">.</span><span class="n">get_security_list</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> secs are fetched and saved."</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.trigger_bars_sync">
<code class="highlight language-python">
trigger_bars_sync<span class="p">(</span><span class="n">sync_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.trigger_bars_sync" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>初始化bars_sync的任务，发信号给各quotes_fetcher进程以启动同步。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>frame_type</code></td>
<td><code>FrameType</code></td>
<td>
<p>要同步的帧类型</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>sync_params</code></td>
<td><code>dict</code></td>
<td>
<p>同步参数
<div class="highlight">
<pre><span></span><code>{
    start: 起始帧
    stop: 截止帧
    frame: 帧类型
    delay: 延迟启动时间，以秒为单位
    cat: 证券分类，如stock, index等
    delay: seconds for sync to wait.
}
</code></pre>
</div>
see more @<a href="#omega.jobs.syncjobs.parse_sync_params">omega.jobs.syncjobs.parse_sync_params</a></p>
</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>force</code></td>
<td><code></code></td>
<td>
<p>即使当前不是交易日，是否也强行进行同步。</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">trigger_bars_sync</span><span class="p">(</span><span class="n">sync_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""初始化bars_sync的任务，发信号给各quotes_fetcher进程以启动同步。</span>

<span class="sd">    Args:</span>
<span class="sd">        frame_type (FrameType): 要同步的帧类型</span>
<span class="sd">        sync_params (dict): 同步参数</span>
<span class="sd">            ```</span>
<span class="sd">            {</span>
<span class="sd">                start: 起始帧</span>
<span class="sd">                stop: 截止帧</span>
<span class="sd">                frame: 帧类型</span>
<span class="sd">                delay: 延迟启动时间，以秒为单位</span>
<span class="sd">                cat: 证券分类，如stock, index等</span>
<span class="sd">                delay: seconds for sync to wait.</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>
<span class="sd">            see more @[omega.jobs.syncjobs.parse_sync_params][]</span>
<span class="sd">        force: 即使当前不是交易日，是否也强行进行同步。</span>
<span class="sd">    Returns:</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">is_trade_day</span><span class="p">(</span><span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="k">return</span>

    <span class="n">codes</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">parse_sync_params</span><span class="p">(</span><span class="o">**</span><span class="n">sync_params</span><span class="p">)</span>
    <span class="n">key_scope</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"jobs.bars_sync.scope.</span><span class="si">{</span><span class="n">frame_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"no securities are specified for sync </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">fmt_str</span> <span class="o">=</span> <span class="s2">"sync from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> in frame_type(</span><span class="si">%s</span><span class="s2">) for </span><span class="si">%s</span><span class="s2"> secs"</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">))</span>

    <span class="c1"># secs are stored into cache, so each fetcher can polling it</span>
    <span class="n">pl</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key_scope</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="n">key_scope</span><span class="p">,</span> <span class="o">*</span><span class="n">codes</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">pl</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">_start_job_timer</span><span class="p">(</span><span class="s2">"sync"</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">emit</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
        <span class="n">Events</span><span class="o">.</span><span class="n">OMEGA_DO_SYNC</span><span class="p">,</span> <span class="p">{</span><span class="s2">"frame_type"</span><span class="p">:</span> <span class="n">frame_type</span><span class="p">,</span> <span class="s2">"start"</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span> <span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">fmt_str</span> <span class="o">=</span> <span class="s2">"send trigger sync event to fetchers: from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> in frame_type(</span><span class="si">%s</span><span class="s2">) for </span><span class="si">%s</span><span class="s2"> secs"</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">frame_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">))</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h5 class="doc doc-heading" id="omega.jobs.syncjobs.trigger_single_worker_sync">
<code class="highlight language-python">
trigger_single_worker_sync<span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-async"><code>async</code></small>
</span>
<a class="headerlink" href="#omega.jobs.syncjobs.trigger_single_worker_sync" title="Permanent link">¶</a></h5>
<div class="doc doc-contents">
<p>启动只需要单个quotes fetcher进程来完成的数据同步任务</p>
<p>比如交易日历、证券列表等如果需要同时启动多个quotes fetcher进程来完成数据同步任务，应该通过
pyemit来发送广播消息。</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_type</code></td>
<td><code>str</code></td>
<td>
<p>the type of data to be synced, either <code>calendar</code> or <code>ecurity_list</code></p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>omega/jobs/syncjobs.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">trigger_single_worker_sync</span><span class="p">(</span><span class="n">_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""启动只需要单个quotes fetcher进程来完成的数据同步任务</span>

<span class="sd">    比如交易日历、证券列表等如果需要同时启动多个quotes fetcher进程来完成数据同步任务，应该通过</span>
<span class="sd">    pyemit来发送广播消息。</span>

<span class="sd">    Args:</span>
<span class="sd">        _type: the type of data to be synced, either ``calendar`` or ``ecurity_list``</span>
<span class="sd">    """</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">quotes_server</span>
    <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">"calendar"</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="s2">"/jobs/sync_calendar"</span>
    <span class="k">elif</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">"security_list"</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="s2">"/jobs/sync_security_list"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s2"> is not supported sync type."</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"failed to trigger </span><span class="si">%s</span><span class="s2"> sync"</span><span class="p">,</span> <span class="n">_type</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav aria-label="Footer" class="md-footer-nav__inner md-grid">
<a class="md-footer-nav__link md-footer-nav__link--prev" href="../history/" rel="prev">
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                版本历史
              </div>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
</div>
</div>
</footer>
</div>
<script src="../assets/javascripts/vendor.18f0862e.min.js"></script>
<script src="../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
<script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
</body>
</html>